# Deferring Works

When to use which:

* Work queues
* Tasklets
* Softirqs
* Timer

## Work Queues

Header file: [`linux/workqueue.h`](https://elixir.bootlin.com/linux/v6.1.65/source/include/linux/workqueue.h)

* Normal work
* Delayed work
* Deferrable work

System and custom work queue (`schedule_work` and `queue_work`)

**Example** - `DECLARE_WORK`

```c
#include <linux/module.h>
#include <linux/printk.h>
#include <linux/workqueue.h>

#define MSG(...) printk("demo: " __VA_ARGS__)

void works_to_do(struct work_struct *work)
{
	MSG("do something\n");
}

DECLARE_WORK(my_work, works_to_do);

static int demo_init(void)
{
	MSG("init\n");
	schedule_work(&my_work);
	return 0;
}

static void demo_exit(void)
{
	MSG("exit\n");
}

module_init(demo_init);
module_exit(demo_exit);

MODULE_LICENSE("GPL");
```

```
[ 5302.639901] demo: init
[ 5302.639912] demo: do something
[ 5307.103101] demo: exit
```

**Example** - `INIT_WORK`

```c
#include <linux/module.h>
#include <linux/printk.h>
#include <linux/workqueue.h>

#define MSG(...) printk("demo: " __VA_ARGS__)

static struct work_struct my_work;

void works_to_do(struct work_struct *work)
{
	MSG("do something\n");
}

static int demo_init(void)
{
	MSG("init\n");
	INIT_WORK(&my_work, works_to_do);
	schedule_work(&my_work);
	return 0;
}

static void demo_exit(void)
{
	MSG("exit\n");
}

module_init(demo_init);
module_exit(demo_exit);

MODULE_LICENSE("GPL");
```

## Tasklets

Header file: [`linux/interrupt.h`](https://elixir.bootlin.com/linux/v6.1.65/source/include/linux/interrupt.h)

**Example** - `DECLARE_TASKLET`

```c
#include <linux/module.h>
#include <linux/printk.h>
#include <linux/interrupt.h>

#define MSG(...) printk("demo: " __VA_ARGS__)

void works_to_do(struct tasklet_struct *task)
{
	MSG("do something\n");
}
DECLARE_TASKLET(my_task, works_to_do);

static int demo_init(void)
{
	MSG("init\n");
	tasklet_schedule(&my_task);
	return 0;
}

static void demo_exit(void)
{
	MSG("exit\n");
}

module_init(demo_init);
module_exit(demo_exit);

MODULE_LICENSE("GPL");
```

**Example** - `tasklet_init()`

```c
#include <linux/module.h>
#include <linux/printk.h>
#include <linux/interrupt.h>

#define MSG(...) printk("demo: " __VA_ARGS__)

static struct tasklet_struct my_task;
void works_to_do(unsigned long data)
{
	MSG("do something\n");
};

static int demo_init(void)
{
	MSG("init\n");
	tasklet_init(&my_task, works_to_do, 0);
	tasklet_schedule(&my_task);
	return 0;
}

static void demo_exit(void)
{
	MSG("exit\n");
}

module_init(demo_init);
module_exit(demo_exit);

MODULE_LICENSE("GPL");
```
## Softirqs

## Timer

## Reference

* https://docs.kernel.org/core-api/workqueue.html